# Compiling the RPi Kernel

There are several reasons why one would want to compile a Linux kernel.

First you might want to upgrade your current LInux kernel to a newer version. You can then download the sources and compile the newer version.

Ofcourse if you want to add features to the kernel or change something you will also need to compile the full kernel to be able to test it out.

Another reason would be the need for the build context of the kernel when developing loadable kernel modules.

This course mainly needs a new compiled kernel for the kernel context to allow the building of loadable kernel modules. Ofcourse it's also a nice challenge to build a Linux kernel for an embedded system.

There are two main methods for building the kernel. You can build locally on a Raspberry Pi which is fairly easy but will take a long time; or you can cross-compile, which is much quicker, but requires more setup.

## Cross-compiling the Kernel

Since we need the kernel for its build context we need to fetch the source code of the kernel version that is currently running on the Raspberry Pi. Once we fetch the source, we need to install a cross-compiler as we are developing and compiling on an x86/AMD64 system but need to kernel to run on an ARM architecture.

Before the compilation process can be started we need to configure the source for the Raspberry Pi 2. This is done by the means of a config file which contains all the settings of the kernel and build system. This file can be generated by the Linux system running on the Raspberry Pi.

Next the compilation can be started and once finished the new kernel can be deployed and tested.

### Current Kernel Version

To build loadable kernel modules, you must have a prebuilt kernel available that contains the configuration and header files used in the build. Also, the kernel must have been built with modules enabled.

This also implies that we need the same or a close to the current kernel version to build. If not the same rather take a newer than older version. Mainly because newer kernel versions will be backward compatible. Older versions may lack newer system_calls or functionality.

To determine the current kernel version running on your Raspberry Pi 2, execute the `uname` command to print out some system information, including the kernel version.

```shell
uname -a
Linux rasp-embedded 4.4.12-v7+ #1 SMP Fri Jun 3 13:15:55 CEST 2016 armv7l GNU/Linux
```

In the example above the system is running a kernel with version '4.4.12'.

### Getting the kernel source

The kernel sources for the modified Raspberry Pi linux kernel can be found at [https://github.com/raspberrypi/linux](https://github.com/raspberrypi/linux).

Find the kernel version between the branches that is running on your Pi.

To save some time and place its best to clone a shallow copy of the repository using the following command:

```shell
cd && git clone --depth 1 -b rpi-4.4.y https://github.com/raspberrypi/linux.git rpi-linux
```

This should take a few minutes after which a directory `rpi-linux` should have been created in your home dir.

### Cross-compiler

Next we need to setup the cross-compiler so we can use our development machine to build programs for an ARM architecture.

Luckely a cross-compiler is readily available. All we need to do is clone it.

```shell
cd && git clone https://github.com/raspberrypi/tools.git rpi-tools
```

This will clone the required tools in your home directory.

Now if we want to cross-compile something we will need to provide the path to the cross-compiler. For the moment we will do it manually inside a terminal by exporting the path to the compiler. Do take note that if you close the terminal the path will be forgotten. So you will need to redo the export. Also do not forget to substitute `<username>` with the username of your account on your development machine.

```shell
export CCPREFIX=/home/<username>/rpi-tools/arm-bcm2708/gcc-linaro-arm-linux-gnueabihf-raspbian/bin/arm-linux-gnueabihf-
```

Make sure not to make any typo's and use tab-completion !

### Configuring the Kernel

While we could configure the kernel ourselves it would save us several days if the configuration of the kernel that is currently running on the Pi can be used. Luckely it can.

For this you will need to login to the Raspberry Pi using ssh:

```shell
ssh pi@<ip-address>
```

The current config can be generated by using the following commands

```shell
sudo modprobe configs
```

This will generate the file `/proc/configs.gz`. By extracting the file we get the actual textual config file.

```shell
cd /tmp
cp /proc/config.gz .
gunzip config.gz
```

Now you can go back to your development machine and copy the config into the linux source tree.

```shell
cd ~/rpi-linux
scp pi@<ip-address>:/tmp/config ./.config
```

Note how the destination file start with a '.' and is thereby a hidden file.

Because chances are that the version of the kernel source we checked out is newer than the version running on the Pi, it is necessary to check the config file for new options. This is done executing a `make oldconfig`.

```shell
ARCH=arm CROSS_COMPILE=${CCPREFIX} make oldconfig
```

Note how we need to provide the actual architecture (ARM in this case) and the path to the cross-compiler.

You will be presented with a list of new options available in the newer kernel. You should be careful what options to enable or disable. However in most cases you can just press ENTER to pick the default option.

### Building the kernel and modules

To build the whole lot the following make command can be used:

```shell
ARCH=arm CROSS_COMPILE=${CCPREFIX} make zImage modules dtbs
```

!!! note "Threads"
	`-j#` sets the number of threads that should be used to build the kernel. It should be set to 1.5* the number of cores in your CPU. So if you have 4 cores, you should set it to 6. On a VM you can omit the argument unless you used more than 1 core.







TODO:
Next, install the modules:

sudo make ARCH=arm CROSS_COMPILE=arm-linux-gnueabihf- INSTALL_MOD_PATH=mnt/ext4 modules_install
Finally, copy the kernel and Device Tree blobs onto the SD card, making sure to back up your old kernel:

sudo cp mnt/fat32/$KERNEL.img mnt/fat32/$KERNEL-backup.img
sudo scripts/mkknlimg arch/arm/boot/zImage mnt/fat32/$KERNEL.img
sudo cp arch/arm/boot/dts/*.dtb mnt/fat32/
sudo cp arch/arm/boot/dts/overlays/*.dtb* mnt/fat32/overlays/
sudo cp arch/arm/boot/dts/overlays/README mnt/fat32/overlays/
sudo umount mnt/fat32
sudo umount mnt/ext4